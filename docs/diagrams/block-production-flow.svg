<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 1150">
  <defs>
    <linearGradient id="stepGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#6366F1;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#4F46E5;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="decisionGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#F59E0B;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D97706;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="successGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="failGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#EF4444;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#DC2626;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="finalityGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#9333EA;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#7C3AED;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="3" stdDeviation="2" flood-opacity="0.25"/>
    </filter>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#94A3B8"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10B981"/>
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#EF4444"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#9333EA"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="900" height="1150" fill="#0F172A"/>

  <!-- Title -->
  <text x="450" y="35" text-anchor="middle" fill="#F8FAFC" font-family="Arial, sans-serif" font-size="22" font-weight="bold">Block Production Flow with GRANDPA Finality</text>
  <text x="450" y="55" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="12">try_produce_block() - produce_block() - store_produced_block() - GRANDPA finalize</text>

  <!-- Start -->
  <g filter="url(#shadow)">
    <ellipse cx="400" cy="100" rx="60" ry="25" fill="#374151"/>
    <text x="400" y="105" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">Slot Tick</text>
  </g>
  <path d="M 400 125 L 400 155" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 1: Check Clock Health -->
  <g filter="url(#shadow)">
    <rect x="280" y="160" width="240" height="50" rx="8" fill="url(#stepGrad)"/>
    <text x="400" y="185" text-anchor="middle" fill="white" font-family="Arial" font-size="12">1. Check Clock Health</text>
    <text x="400" y="200" text-anchor="middle" fill="white" font-family="Arial" font-size="10">can_produce_blocks()</text>
  </g>
  <path d="M 400 210 L 400 240" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Decision: Clock OK? -->
  <g filter="url(#shadow)">
    <polygon points="400,245 470,280 400,315 330,280" fill="url(#decisionGrad)"/>
    <text x="400" y="283" text-anchor="middle" fill="white" font-family="Arial" font-size="11">Clock OK?</text>
  </g>

  <!-- No branch -->
  <path d="M 330 280 L 230 280" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowRed)"/>
  <text x="280" y="270" text-anchor="middle" fill="#EF4444" font-family="Arial" font-size="10">No</text>
  <g filter="url(#shadow)">
    <rect x="130" y="260" width="100" height="40" rx="6" fill="url(#failGrad)"/>
    <text x="180" y="285" text-anchor="middle" fill="white" font-family="Arial" font-size="11">Skip Slot</text>
  </g>

  <!-- Yes branch -->
  <path d="M 400 315 L 400 340" stroke="#10B981" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <text x="415" y="330" fill="#10B981" font-family="Arial" font-size="10">Yes</text>

  <!-- Step 2: VRF Slot Leader Check -->
  <g filter="url(#shadow)">
    <rect x="280" y="345" width="240" height="50" rx="8" fill="url(#stepGrad)"/>
    <text x="400" y="370" text-anchor="middle" fill="white" font-family="Arial" font-size="12">2. VRF Slot Leader Check</text>
    <text x="400" y="385" text-anchor="middle" fill="white" font-family="Arial" font-size="10">is_slot_leader(slot, epoch, validators)</text>
  </g>
  <path d="M 400 395 L 400 420" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Decision: Slot Leader? -->
  <g filter="url(#shadow)">
    <polygon points="400,425 480,460 400,495 320,460" fill="url(#decisionGrad)"/>
    <text x="400" y="463" text-anchor="middle" fill="white" font-family="Arial" font-size="11">Slot Leader?</text>
  </g>

  <!-- No branch -->
  <path d="M 320 460 L 230 460" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowRed)"/>
  <text x="275" y="450" text-anchor="middle" fill="#EF4444" font-family="Arial" font-size="10">No</text>
  <g filter="url(#shadow)">
    <rect x="130" y="440" width="100" height="40" rx="6" fill="url(#failGrad)"/>
    <text x="180" y="465" text-anchor="middle" fill="white" font-family="Arial" font-size="11">Not Our Turn</text>
  </g>

  <!-- Yes branch -->
  <path d="M 400 495 L 400 515" stroke="#10B981" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <text x="415" y="508" fill="#10B981" font-family="Arial" font-size="10">Yes</text>

  <!-- Step 3: Select Transactions -->
  <g filter="url(#shadow)">
    <rect x="280" y="520" width="240" height="45" rx="8" fill="url(#stepGrad)"/>
    <text x="400" y="542" text-anchor="middle" fill="white" font-family="Arial" font-size="12">3. Select Transactions</text>
    <text x="400" y="558" text-anchor="middle" fill="white" font-family="Arial" font-size="10">select_transactions_with_state()</text>
  </g>
  <path d="M 400 565 L 400 585" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 4: Execute Transactions -->
  <g filter="url(#shadow)">
    <rect x="280" y="590" width="240" height="55" rx="8" fill="url(#stepGrad)"/>
    <text x="400" y="612" text-anchor="middle" fill="white" font-family="Arial" font-size="12">4. Execute Transactions</text>
    <text x="400" y="627" text-anchor="middle" fill="white" font-family="Arial" font-size="10">TransactionExecutor::execute()</text>
    <text x="400" y="640" text-anchor="middle" fill="white" font-family="Arial" font-size="9">Transfer | ProposeValidator | Vote</text>
  </g>
  <path d="M 400 645 L 400 665" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 5: Apply Rewards -->
  <g filter="url(#shadow)">
    <rect x="280" y="670" width="240" height="45" rx="8" fill="url(#stepGrad)"/>
    <text x="400" y="692" text-anchor="middle" fill="white" font-family="Arial" font-size="12">5. Apply Block Rewards</text>
    <text x="400" y="708" text-anchor="middle" fill="white" font-family="Arial" font-size="10">validator_account.free += reward</text>
  </g>
  <path d="M 400 715 L 400 735" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 6: Compute State Root -->
  <g filter="url(#shadow)">
    <rect x="280" y="740" width="240" height="45" rx="8" fill="url(#stepGrad)"/>
    <text x="400" y="762" text-anchor="middle" fill="white" font-family="Arial" font-size="12">6. Compute State Root</text>
    <text x="400" y="778" text-anchor="middle" fill="white" font-family="Arial" font-size="10">compute_state_root(block_number)</text>
  </g>
  <path d="M 400 785 L 400 805" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 7: Sign and Store -->
  <g filter="url(#shadow)">
    <rect x="280" y="810" width="240" height="45" rx="8" fill="url(#successGrad)"/>
    <text x="400" y="832" text-anchor="middle" fill="white" font-family="Arial" font-size="12">7. Sign Block and Store</text>
    <text x="400" y="848" text-anchor="middle" fill="white" font-family="Arial" font-size="10">store_produced_block(block)</text>
  </g>
  <path d="M 400 855 L 400 875" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 8: Broadcast Block -->
  <g filter="url(#shadow)">
    <rect x="280" y="880" width="240" height="45" rx="8" fill="url(#stepGrad)"/>
    <text x="400" y="902" text-anchor="middle" fill="white" font-family="Arial" font-size="12">8. Broadcast Block</text>
    <text x="400" y="918" text-anchor="middle" fill="white" font-family="Arial" font-size="10">gossipsub.publish(block)</text>
  </g>
  <path d="M 400 925 L 400 945" stroke="#9333EA" stroke-width="2" marker-end="url(#arrowPurple)"/>

  <!-- GRANDPA Finality Section -->
  <rect x="250" y="955" width="300" height="180" rx="10" fill="none" stroke="#9333EA" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="400" y="975" text-anchor="middle" fill="#C4B5FD" font-family="Arial" font-size="11" font-weight="bold">GRANDPA Finality Gadget</text>

  <!-- Step 9: Prevote -->
  <g filter="url(#shadow)">
    <rect x="270" y="985" width="260" height="40" rx="6" fill="url(#finalityGrad)"/>
    <text x="400" y="1005" text-anchor="middle" fill="white" font-family="Arial" font-size="11">9. Prevote (best chain)</text>
    <text x="400" y="1018" text-anchor="middle" fill="white" font-family="Arial" font-size="9">Broadcast to validators</text>
  </g>
  <path d="M 400 1025 L 400 1040" stroke="#9333EA" stroke-width="2" marker-end="url(#arrowPurple)"/>

  <!-- Step 10: Precommit -->
  <g filter="url(#shadow)">
    <rect x="270" y="1045" width="260" height="40" rx="6" fill="url(#finalityGrad)"/>
    <text x="400" y="1065" text-anchor="middle" fill="white" font-family="Arial" font-size="11">10. Precommit (2/3 prevotes)</text>
    <text x="400" y="1078" text-anchor="middle" fill="white" font-family="Arial" font-size="9">66% threshold required</text>
  </g>
  <path d="M 400 1085 L 400 1100" stroke="#9333EA" stroke-width="2" marker-end="url(#arrowPurple)"/>

  <!-- End: Finalized -->
  <g filter="url(#shadow)">
    <ellipse cx="400" cy="1120" rx="80" ry="25" fill="url(#successGrad)"/>
    <text x="400" y="1125" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">Block Finalized</text>
  </g>

  <!-- Side annotations -->
  <g>
    <rect x="560" y="345" width="200" height="95" rx="6" fill="#1E293B" stroke="#4F46E5" stroke-width="1"/>
    <text x="660" y="367" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="10" font-weight="bold">VRF Weight Formula</text>
    <text x="660" y="387" text-anchor="middle" fill="#818CF8" font-family="monospace" font-size="9">min(sqrt(stake), sqrt(1M)) x ln(1+VC)</text>
    <text x="660" y="405" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">STAKE_CAP = 1,000,000 KRAT</text>
    <text x="660" y="420" text-anchor="middle" fill="#F59E0B" font-family="Arial" font-size="8">Bootstrap: stake=10.0, VC at least 100</text>
    <text x="660" y="435" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">VC = reputation/uptime</text>
  </g>

  <g>
    <rect x="560" y="520" width="200" height="60" rx="6" fill="#1E293B" stroke="#10B981" stroke-width="1"/>
    <text x="660" y="540" text-anchor="middle" fill="#10B981" font-family="Arial" font-size="10" font-weight="bold">State-Aware Selection</text>
    <text x="660" y="558" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">Queries account nonces from state</text>
    <text x="660" y="572" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">Handles nonce greater than 0</text>
  </g>

  <g>
    <rect x="560" y="670" width="200" height="60" rx="6" fill="#1E293B" stroke="#10B981" stroke-width="1"/>
    <text x="660" y="695" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="10" font-weight="bold">Block Reward</text>
    <text x="660" y="715" text-anchor="middle" fill="#10B981" font-family="Arial" font-size="9">~12.37 KRAT/block</text>
    <text x="660" y="725" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">(6.5% annual @ 1B supply)</text>
  </g>

  <!-- GRANDPA annotation -->
  <g>
    <rect x="560" y="985" width="200" height="100" rx="6" fill="#1E293B" stroke="#9333EA" stroke-width="1"/>
    <text x="660" y="1007" text-anchor="middle" fill="#C4B5FD" font-family="Arial" font-size="10" font-weight="bold">GRANDPA Finality</text>
    <text x="660" y="1027" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">Threshold: 66% (2/3)</text>
    <text x="660" y="1042" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">Round timeout: 6 seconds</text>
    <text x="660" y="1057" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">Min validators: 3</text>
    <text x="660" y="1072" text-anchor="middle" fill="#10B981" font-family="Arial" font-size="8">10% fees to voters</text>
  </g>

  <!-- Fee distribution annotation -->
  <g>
    <rect x="560" y="810" width="200" height="70" rx="6" fill="#1E293B" stroke="#F59E0B" stroke-width="1"/>
    <text x="660" y="830" text-anchor="middle" fill="#F59E0B" font-family="Arial" font-size="10" font-weight="bold">Fee Distribution</text>
    <text x="660" y="848" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">50% Producer | 10% Finality Voters</text>
    <text x="660" y="862" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">30% Burn | 10% Treasury</text>
  </g>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 900">
  <defs>
    <linearGradient id="stepGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#6366F1;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#4F46E5;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="decisionGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#F59E0B;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D97706;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="successGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="failGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#EF4444;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#DC2626;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="3" stdDeviation="2" flood-opacity="0.25"/>
    </filter>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#94A3B8"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10B981"/>
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#EF4444"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="800" height="900" fill="#0F172A"/>

  <!-- Title -->
  <text x="400" y="35" text-anchor="middle" fill="#F8FAFC" font-family="Arial, sans-serif" font-size="22" font-weight="bold">Block Production Flow</text>
  <text x="400" y="55" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="12">try_produce_block() → produce_block() → store_produced_block()</text>

  <!-- Start -->
  <g filter="url(#shadow)">
    <ellipse cx="400" cy="100" rx="60" ry="25" fill="#374151"/>
    <text x="400" y="105" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">Slot Tick</text>
  </g>
  <path d="M 400 125 L 400 155" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 1: Check Clock Health -->
  <g filter="url(#shadow)">
    <rect x="280" y="160" width="240" height="50" rx="8" fill="url(#stepGrad)"/>
    <text x="400" y="185" text-anchor="middle" fill="white" font-family="Arial" font-size="12">1. Check Clock Health</text>
    <text x="400" y="200" text-anchor="middle" fill="white" font-family="Arial" font-size="10">can_produce_blocks()</text>
  </g>
  <path d="M 400 210 L 400 240" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Decision: Clock OK? -->
  <g filter="url(#shadow)">
    <polygon points="400,245 470,280 400,315 330,280" fill="url(#decisionGrad)"/>
    <text x="400" y="283" text-anchor="middle" fill="white" font-family="Arial" font-size="11">Clock OK?</text>
  </g>

  <!-- No branch -->
  <path d="M 330 280 L 230 280" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowRed)"/>
  <text x="280" y="270" text-anchor="middle" fill="#EF4444" font-family="Arial" font-size="10">No</text>
  <g filter="url(#shadow)">
    <rect x="130" y="260" width="100" height="40" rx="6" fill="url(#failGrad)"/>
    <text x="180" y="285" text-anchor="middle" fill="white" font-family="Arial" font-size="11">Skip Slot</text>
  </g>

  <!-- Yes branch -->
  <path d="M 400 315 L 400 345" stroke="#10B981" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <text x="415" y="335" fill="#10B981" font-family="Arial" font-size="10">Yes</text>

  <!-- Step 2: VRF Slot Leader Check -->
  <g filter="url(#shadow)">
    <rect x="280" y="350" width="240" height="50" rx="8" fill="url(#stepGrad)"/>
    <text x="400" y="375" text-anchor="middle" fill="white" font-family="Arial" font-size="12">2. VRF Slot Leader Check</text>
    <text x="400" y="390" text-anchor="middle" fill="white" font-family="Arial" font-size="10">is_slot_leader(slot, epoch, validators)</text>
  </g>
  <path d="M 400 400 L 400 430" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Decision: Slot Leader? -->
  <g filter="url(#shadow)">
    <polygon points="400,435 480,475 400,515 320,475" fill="url(#decisionGrad)"/>
    <text x="400" y="478" text-anchor="middle" fill="white" font-family="Arial" font-size="11">Slot Leader?</text>
  </g>

  <!-- No branch -->
  <path d="M 320 475 L 230 475" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowRed)"/>
  <text x="275" y="465" text-anchor="middle" fill="#EF4444" font-family="Arial" font-size="10">No</text>
  <g filter="url(#shadow)">
    <rect x="130" y="455" width="100" height="40" rx="6" fill="url(#failGrad)"/>
    <text x="180" y="480" text-anchor="middle" fill="white" font-family="Arial" font-size="11">Not Our Turn</text>
  </g>

  <!-- Yes branch -->
  <path d="M 400 515 L 400 545" stroke="#10B981" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <text x="415" y="535" fill="#10B981" font-family="Arial" font-size="10">Yes</text>

  <!-- Step 3: Execute Transactions -->
  <g filter="url(#shadow)">
    <rect x="280" y="550" width="240" height="60" rx="8" fill="url(#stepGrad)"/>
    <text x="400" y="575" text-anchor="middle" fill="white" font-family="Arial" font-size="12">3. Execute Transactions</text>
    <text x="400" y="590" text-anchor="middle" fill="white" font-family="Arial" font-size="10">TransactionExecutor::execute()</text>
    <text x="400" y="603" text-anchor="middle" fill="white" font-family="Arial" font-size="9">Transfer | ProposeValidator | Vote</text>
  </g>
  <path d="M 400 610 L 400 640" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 4: Apply Rewards -->
  <g filter="url(#shadow)">
    <rect x="280" y="645" width="240" height="50" rx="8" fill="url(#stepGrad)"/>
    <text x="400" y="670" text-anchor="middle" fill="white" font-family="Arial" font-size="12">4. Apply Block Rewards</text>
    <text x="400" y="685" text-anchor="middle" fill="white" font-family="Arial" font-size="10">validator_account.free += reward</text>
  </g>
  <path d="M 400 695 L 400 725" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 5: Compute State Root -->
  <g filter="url(#shadow)">
    <rect x="280" y="730" width="240" height="50" rx="8" fill="url(#stepGrad)"/>
    <text x="400" y="755" text-anchor="middle" fill="white" font-family="Arial" font-size="12">5. Compute State Root</text>
    <text x="400" y="770" text-anchor="middle" fill="white" font-family="Arial" font-size="10">compute_state_root(block_number)</text>
  </g>
  <path d="M 400 780 L 400 810" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 6: Sign & Store -->
  <g filter="url(#shadow)">
    <rect x="280" y="815" width="240" height="50" rx="8" fill="url(#successGrad)"/>
    <text x="400" y="840" text-anchor="middle" fill="white" font-family="Arial" font-size="12">6. Sign Block & Store</text>
    <text x="400" y="855" text-anchor="middle" fill="white" font-family="Arial" font-size="10">store_produced_block(block)</text>
  </g>

  <!-- Side annotations -->
  <g>
    <rect x="560" y="350" width="200" height="95" rx="6" fill="#1E293B" stroke="#4F46E5" stroke-width="1"/>
    <text x="660" y="372" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="10" font-weight="bold">VRF Weight Formula</text>
    <text x="660" y="392" text-anchor="middle" fill="#818CF8" font-family="monospace" font-size="9">min(√stake, √1M) × ln(1+VC)</text>
    <text x="660" y="410" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">STAKE_CAP = 1,000,000 KRAT</text>
    <text x="660" y="425" text-anchor="middle" fill="#F59E0B" font-family="Arial" font-size="8">Bootstrap: stake=10.0, VC≥100</text>
    <text x="660" y="440" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">VC = reputation/uptime</text>
  </g>

  <g>
    <rect x="560" y="645" width="200" height="60" rx="6" fill="#1E293B" stroke="#10B981" stroke-width="1"/>
    <text x="660" y="670" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="10" font-weight="bold">Block Reward</text>
    <text x="660" y="690" text-anchor="middle" fill="#10B981" font-family="Arial" font-size="9">~12.37 KRAT/block</text>
    <text x="660" y="700" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="8">(6.5% annual @ 1B supply)</text>
  </g>
</svg>

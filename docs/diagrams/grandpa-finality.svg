<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 700">
  <defs>
    <linearGradient id="prevoteGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#F59E0B;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D97706;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="precommitGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#8B5CF6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#7C3AED;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="finalizedGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="voteGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#2563EB;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="3" stdDeviation="2" flood-opacity="0.25"/>
    </filter>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#94A3B8"/>
    </marker>
    <marker id="greenArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10B981"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1000" height="700" fill="#0F172A"/>

  <!-- Title -->
  <text x="500" y="35" text-anchor="middle" fill="#F8FAFC" font-family="Arial, sans-serif" font-size="24" font-weight="bold">GRANDPA Finality Protocol</text>
  <text x="500" y="58" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="13">Byzantine Fault Tolerant Block Finalization</text>

  <!-- Phase Timeline -->
  <rect x="50" y="85" width="900" height="50" rx="8" fill="#1E293B"/>

  <!-- Prevoting Phase -->
  <rect x="60" y="92" width="280" height="36" rx="6" fill="url(#prevoteGrad)"/>
  <text x="200" y="115" text-anchor="middle" fill="white" font-family="Arial" font-size="13" font-weight="bold">Prevoting Phase</text>

  <!-- Arrow 1 -->
  <path d="M 350 110 L 380 110" stroke="#94A3B8" stroke-width="3" marker-end="url(#arrow)"/>
  <text x="365" y="100" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="9">2/3</text>

  <!-- Precommitting Phase -->
  <rect x="390" y="92" width="280" height="36" rx="6" fill="url(#precommitGrad)"/>
  <text x="530" y="115" text-anchor="middle" fill="white" font-family="Arial" font-size="13" font-weight="bold">Precommitting Phase</text>

  <!-- Arrow 2 -->
  <path d="M 680 110 L 710 110" stroke="#94A3B8" stroke-width="3" marker-end="url(#arrow)"/>
  <text x="695" y="100" text-anchor="middle" fill="#94A3B8" font-family="Arial" font-size="9">2/3</text>

  <!-- Finalized -->
  <rect x="720" y="92" width="220" height="36" rx="6" fill="url(#finalizedGrad)"/>
  <text x="830" y="115" text-anchor="middle" fill="white" font-family="Arial" font-size="13" font-weight="bold">FINALIZED</text>

  <!-- Vote Structure Box -->
  <g filter="url(#shadow)">
    <rect x="50" y="160" width="400" height="200" rx="10" fill="#1E293B"/>
    <text x="250" y="190" text-anchor="middle" fill="#F8FAFC" font-family="Arial" font-size="15" font-weight="bold">FinalityVote Structure</text>
    <line x1="70" y1="200" x2="430" y2="200" stroke="#374151" stroke-width="1"/>

    <text x="80" y="225" fill="#94A3B8" font-family="monospace" font-size="11">vote_type:</text>
    <text x="200" y="225" fill="#F59E0B" font-family="monospace" font-size="11">Prevote | Precommit</text>

    <text x="80" y="248" fill="#94A3B8" font-family="monospace" font-size="11">target_number:</text>
    <text x="200" y="248" fill="#60A5FA" font-family="monospace" font-size="11">BlockNumber (u64)</text>

    <text x="80" y="271" fill="#94A3B8" font-family="monospace" font-size="11">target_hash:</text>
    <text x="200" y="271" fill="#60A5FA" font-family="monospace" font-size="11">Hash (32 bytes)</text>

    <text x="80" y="294" fill="#94A3B8" font-family="monospace" font-size="11">round:</text>
    <text x="200" y="294" fill="#60A5FA" font-family="monospace" font-size="11">u32</text>

    <text x="80" y="317" fill="#94A3B8" font-family="monospace" font-size="11">voter:</text>
    <text x="200" y="317" fill="#60A5FA" font-family="monospace" font-size="11">AccountId (Ed25519)</text>

    <text x="80" y="340" fill="#94A3B8" font-family="monospace" font-size="11">signature:</text>
    <text x="200" y="340" fill="#10B981" font-family="monospace" font-size="11">Signature64</text>
  </g>

  <!-- Supermajority Box -->
  <g filter="url(#shadow)">
    <rect x="480" y="160" width="470" height="100" rx="10" fill="#1E293B"/>
    <text x="715" y="190" text-anchor="middle" fill="#F8FAFC" font-family="Arial" font-size="15" font-weight="bold">Supermajority Threshold</text>
    <line x1="500" y1="200" x2="930" y2="200" stroke="#374151" stroke-width="1"/>

    <rect x="510" y="215" width="420" height="30" rx="4" fill="rgba(16,185,129,0.2)"/>
    <text x="720" y="235" text-anchor="middle" fill="#10B981" font-family="monospace" font-size="12">count * 100 >= total * 66  // 2/3 = 66%</text>
  </g>

  <!-- Round States -->
  <g filter="url(#shadow)">
    <rect x="480" y="275" width="470" height="85" rx="10" fill="#1E293B"/>
    <text x="715" y="300" text-anchor="middle" fill="#F8FAFC" font-family="Arial" font-size="14" font-weight="bold">Round States</text>
    <line x1="500" y1="310" x2="930" y2="310" stroke="#374151" stroke-width="1"/>

    <!-- State flow -->
    <rect x="510" y="320" width="80" height="25" rx="4" fill="url(#prevoteGrad)"/>
    <text x="550" y="337" text-anchor="middle" fill="white" font-family="Arial" font-size="10">Prevoting</text>

    <path d="M 595 332 L 625 332" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

    <rect x="635" y="320" width="100" height="25" rx="4" fill="url(#precommitGrad)"/>
    <text x="685" y="337" text-anchor="middle" fill="white" font-family="Arial" font-size="10">Precommitting</text>

    <path d="M 740 332 L 770 332" stroke="#94A3B8" stroke-width="2" marker-end="url(#arrow)"/>

    <rect x="780" y="320" width="80" height="25" rx="4" fill="url(#finalizedGrad)"/>
    <text x="820" y="337" text-anchor="middle" fill="white" font-family="Arial" font-size="10">Completed</text>

    <!-- Failed state -->
    <rect x="870" y="320" width="60" height="25" rx="4" fill="#DC2626"/>
    <text x="900" y="337" text-anchor="middle" fill="white" font-family="Arial" font-size="10">Failed</text>
  </g>

  <!-- Validators Voting Diagram -->
  <g filter="url(#shadow)">
    <rect x="50" y="385" width="900" height="180" rx="10" fill="#1E293B"/>
    <text x="500" y="415" text-anchor="middle" fill="#F8FAFC" font-family="Arial" font-size="15" font-weight="bold">Voting Flow Example (3 Validators)</text>
    <line x1="70" y1="425" x2="930" y2="425" stroke="#374151" stroke-width="1"/>

    <!-- Validator icons -->
    <circle cx="120" cy="470" r="20" fill="url(#voteGrad)"/>
    <text x="120" y="475" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">V1</text>

    <circle cx="120" cy="520" r="20" fill="url(#voteGrad)"/>
    <text x="120" y="525" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">V2</text>

    <circle cx="120" cy="520" r="20" fill="url(#voteGrad)"/>
    <text x="120" y="525" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">V2</text>

    <!-- Third validator -->
    <circle cx="120" cy="520" r="20" fill="url(#voteGrad)" transform="translate(0, 48)"/>
    <text x="120" y="573" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">V3</text>

    <!-- Prevote arrows -->
    <text x="250" y="450" text-anchor="middle" fill="#F59E0B" font-family="Arial" font-size="11" font-weight="bold">PREVOTES</text>

    <line x1="145" y1="470" x2="320" y2="470" stroke="#F59E0B" stroke-width="2" stroke-dasharray="5,3"/>
    <circle cx="330" cy="470" r="8" fill="#F59E0B"/>

    <line x1="145" y1="520" x2="320" y2="520" stroke="#F59E0B" stroke-width="2" stroke-dasharray="5,3"/>
    <circle cx="330" cy="520" r="8" fill="#F59E0B"/>

    <!-- Third line adjusted -->
    <line x1="145" y1="568" x2="320" y2="568" stroke="#F59E0B" stroke-width="2" stroke-dasharray="5,3"/>
    <circle cx="330" cy="568" r="8" fill="#F59E0B"/>

    <!-- Threshold check -->
    <rect x="360" y="495" width="100" height="50" rx="6" fill="#374151"/>
    <text x="410" y="515" text-anchor="middle" fill="#F59E0B" font-family="Arial" font-size="11">3/3 = 100%</text>
    <text x="410" y="532" text-anchor="middle" fill="#10B981" font-family="Arial" font-size="10">>= 66%</text>

    <!-- Arrow to precommit -->
    <path d="M 470 520 L 510 520" stroke="#10B981" stroke-width="3" marker-end="url(#greenArrow)"/>

    <!-- Precommit phase -->
    <text x="600" y="450" text-anchor="middle" fill="#8B5CF6" font-family="Arial" font-size="11" font-weight="bold">PRECOMMITS</text>

    <line x1="530" y1="470" x2="680" y2="470" stroke="#8B5CF6" stroke-width="2" stroke-dasharray="5,3"/>
    <circle cx="690" cy="470" r="8" fill="#8B5CF6"/>

    <line x1="530" y1="520" x2="680" y2="520" stroke="#8B5CF6" stroke-width="2" stroke-dasharray="5,3"/>
    <circle cx="690" cy="520" r="8" fill="#8B5CF6"/>

    <line x1="530" y1="568" x2="680" y2="568" stroke="#8B5CF6" stroke-width="2" stroke-dasharray="5,3"/>
    <circle cx="690" cy="568" r="8" fill="#8B5CF6"/>

    <!-- Threshold check 2 -->
    <rect x="720" y="495" width="100" height="50" rx="6" fill="#374151"/>
    <text x="770" y="515" text-anchor="middle" fill="#8B5CF6" font-family="Arial" font-size="11">3/3 = 100%</text>
    <text x="770" y="532" text-anchor="middle" fill="#10B981" font-family="Arial" font-size="10">>= 66%</text>

    <!-- Final -->
    <path d="M 830 520 L 860 520" stroke="#10B981" stroke-width="3" marker-end="url(#greenArrow)"/>

    <rect x="870" y="490" width="70" height="60" rx="8" fill="url(#finalizedGrad)"/>
    <text x="905" y="515" text-anchor="middle" fill="white" font-family="Arial" font-size="11" font-weight="bold">BLOCK</text>
    <text x="905" y="535" text-anchor="middle" fill="white" font-family="Arial" font-size="10">FINAL</text>
  </g>

  <!-- Network Messages -->
  <g filter="url(#shadow)">
    <rect x="50" y="585" width="440" height="95" rx="10" fill="#1E293B"/>
    <text x="270" y="610" text-anchor="middle" fill="#F8FAFC" font-family="Arial" font-size="14" font-weight="bold">Network Messages</text>
    <line x1="70" y1="620" x2="470" y2="620" stroke="#374151" stroke-width="1"/>

    <text x="80" y="642" fill="#60A5FA" font-family="monospace" font-size="10">FinalityVote</text>
    <text x="200" y="642" fill="#94A3B8" font-family="Arial" font-size="10">- Broadcast prevote/precommit</text>

    <text x="80" y="660" fill="#60A5FA" font-family="monospace" font-size="10">FinalityJustification</text>
    <text x="200" y="660" fill="#94A3B8" font-family="Arial" font-size="10">- Completed finalization</text>

    <text x="270" y="642" fill="#60A5FA" font-family="monospace" font-size="10">FinalityVotesRequest</text>
    <text x="400" y="642" fill="#94A3B8" font-family="Arial" font-size="10">- Catch-up</text>
  </g>

  <!-- Config -->
  <g filter="url(#shadow)">
    <rect x="510" y="585" width="440" height="95" rx="10" fill="#1E293B"/>
    <text x="730" y="610" text-anchor="middle" fill="#F8FAFC" font-family="Arial" font-size="14" font-weight="bold">Configuration</text>
    <line x1="530" y1="620" x2="930" y2="620" stroke="#374151" stroke-width="1"/>

    <text x="545" y="642" fill="#94A3B8" font-family="Arial" font-size="10">Round Timeout:</text>
    <text x="650" y="642" fill="#10B981" font-family="monospace" font-size="10">6 seconds</text>

    <text x="545" y="660" fill="#94A3B8" font-family="Arial" font-size="10">Min Validators:</text>
    <text x="650" y="660" fill="#10B981" font-family="monospace" font-size="10">3</text>

    <text x="730" y="642" fill="#94A3B8" font-family="Arial" font-size="10">Gossip Topic:</text>
    <text x="820" y="642" fill="#60A5FA" font-family="monospace" font-size="10">/kratos/finality/1.0.0</text>

    <text x="730" y="660" fill="#94A3B8" font-family="Arial" font-size="10">Domain:</text>
    <text x="820" y="660" fill="#F59E0B" font-family="monospace" font-size="10">KRATOS_FINALITY_V1:</text>
  </g>

  <!-- Fee Distribution -->
  <g>
    <rect x="270" y="635" width="200" height="38" rx="4" fill="rgba(16,185,129,0.15)" stroke="#10B981" stroke-width="1"/>
    <text x="370" y="652" text-anchor="middle" fill="#10B981" font-family="Arial" font-size="10" font-weight="bold">Fee Distribution to Voters</text>
    <text x="370" y="666" text-anchor="middle" fill="#94A3B8" font-family="monospace" font-size="9">10% of fees / voters.len()</text>
  </g>

  <!-- Source reference -->
  <text x="500" y="695" text-anchor="middle" fill="#475569" font-family="Arial" font-size="9">
    SPEC_3 ยง6 | node/finality_integration.rs | consensus/finality/ | network/protocol.rs
  </text>
</svg>
